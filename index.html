<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppeneinteilung mit Speicherfunktion</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-section.drag-over {
            border-color: #28a745;
            background: #e8f5e9;
            transform: scale(1.02);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 15px 30px;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .save-section {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .save-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .save-controls input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .saved-lists {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .saved-list-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .saved-list-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .saved-list-item.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .saved-list-name {
            font-weight: 600;
            cursor: pointer;
            flex: 1;
        }

        .saved-list-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .person-list {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .person-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .person-item.ignored {
            opacity: 0.5;
            background: #f0f0f0;
            text-decoration: line-through;
        }

        .person-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .person-name {
            flex: 1;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        input[type="number"],
        select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="number"]:focus,
        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #28a745;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-save {
            background: #17a2b8;
            color: white;
        }

        .btn-save:hover:not(:disabled) {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .group {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .group:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .group-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        }

        .group-members {
            list-style: none;
        }

        .group-members li {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            margin-bottom: 8px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .info-text {
            color: #666;
            text-align: center;
            margin: 20px 0;
        }

        .file-name {
            margin-top: 15px;
            color: #667eea;
            font-weight: 600;
        }

        .stats-info {
            background: #e8f5e9;
            border-left: 4px solid #28a745;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .groups-container {
                grid-template-columns: 1fr;
            }

            .saved-lists {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìä Gruppeneinteilung</h1>

        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <p style="color: #666; margin-bottom: 15px;">Datei hochladen (Excel oder CSV)</p>
            <div class="file-input-wrapper">
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
                <label for="fileInput" class="file-input-label">
                    üìÅ Datei ausw√§hlen
                </label>
            </div>
            <div class="file-name" id="fileName"></div>
        </div>

        <!-- Save/Load Section -->
        <div class="save-section">
            <h2>üíæ Listen verwalten</h2>
            <div class="save-controls">
                <input type="text" id="listName" placeholder="Name der Liste">
                <button class="btn-save" onclick="saveCurrentList()">Liste speichern</button>
            </div>
            <div class="saved-lists" id="savedLists"></div>
        </div>

        <!-- Person List with Ignore Option -->
        <div id="personListSection" style="display: none;">
            <h2>üë• Personen (klicken zum Ignorieren)</h2>
            <div class="stats-info" id="statsInfo"></div>
            <div class="person-list" id="personList"></div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="nameColumn">Spalte: Vorname (0-basiert)</label>
                <input type="number" id="nameColumn" value="0" min="0">
            </div>

            <div class="control-group">
                <label for="lastNameColumn">Spalte: Nachname (-1 = keine)</label>
                <input type="number" id="lastNameColumn" value="-1" min="-1">
            </div>

            <div class="control-group">
                <label for="exclusionColumn">Spalte: Ausschl√ºsse (-1 = keine)</label>
                <input type="number" id="exclusionColumn" value="1" min="-1">
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="ignoreFirstRow" checked> Erste Zeile ignorieren (√úberschrift)
                </label>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="divisionMode">Aufteilungsmodus</label>
                <select id="divisionMode">
                    <option value="count">Anzahl Gruppen</option>
                    <option value="size">Gruppengr√∂√üe</option>
                </select>
            </div>

            <div class="control-group">
                <label for="groupValue">Wert</label>
                <input type="number" id="groupValue" value="3" min="1">
            </div>

            <div class="control-group">
                <label for="remainderMode">Rest-Modus (nur bei Gruppengr√∂√üe)</label>
                <select id="remainderMode">
                    <option value="distribute">Verteilen</option>
                    <option value="separate">Kleinere Gruppen</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="divideBtn" onclick="divideIntoGroups()" disabled>
                üé≤ Gruppen einteilen
            </button>
            <button class="btn-secondary" id="exportBtn" onclick="exportToExcel()" disabled>
                üíæ Als Excel exportieren
            </button>
        </div>

        <div class="groups-container" id="groupsContainer"></div>
    </div>

    <script>
        let currentData = [];
        let currentGroups = [];
        let currentListName = null;
        let ignoredPersons = new Set();

        const fileInput = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const uploadSection = document.getElementById('uploadSection');
        const divideBtn = document.getElementById('divideBtn');
        const exportBtn = document.getElementById('exportBtn');
        const groupsContainer = document.getElementById('groupsContainer');
        const divisionMode = document.getElementById('divisionMode');
        const groupValue = document.getElementById('groupValue');
        const remainderMode = document.getElementById('remainderMode');
        const nameColumn = document.getElementById('nameColumn');
        const lastNameColumn = document.getElementById('lastNameColumn');
        const exclusionColumn = document.getElementById('exclusionColumn');
        const ignoreFirstRow = document.getElementById('ignoreFirstRow');
        const personListSection = document.getElementById('personListSection');
        const personList = document.getElementById('personList');
        const statsInfo = document.getElementById('statsInfo');
        const listNameInput = document.getElementById('listName');
        const savedListsContainer = document.getElementById('savedLists');

        // Load saved lists on startup
        loadSavedLists();

        // File input handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });

        // Drag and drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-over');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('drag-over');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (file) {
                processFile(file);
            }
        });

        function processFile(file) {
            fileName.textContent = `üìÑ ${file.name}`;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    currentData = jsonData.filter(row => row && row.length > 0);
                    ignoredPersons.clear();

                    if (currentData.length > 0) {
                        divideBtn.disabled = false;
                        displayPersonList();
                        alert(`‚úÖ ${currentData.length} Zeilen erfolgreich geladen!`);
                    }
                } catch (error) {
                    alert('‚ùå Fehler beim Lesen der Datei: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function displayPersonList() {
            const skipFirstRow = ignoreFirstRow.checked;
            const firstNameColIndex = parseInt(nameColumn.value);
            const lastNameColIndex = parseInt(lastNameColumn.value);

            let dataToShow = [...currentData];
            if (skipFirstRow && dataToShow.length > 0) {
                dataToShow = dataToShow.slice(1);
            }

            personList.innerHTML = '';
            personListSection.style.display = 'block';

            const persons = [];
            dataToShow.forEach((row, index) => {
                const firstName = row[firstNameColIndex];
                const lastName = lastNameColIndex >= 0 ? row[lastNameColIndex] : '';

                if (firstName && firstName.toString().trim() !== '') {
                    const firstNameStr = firstName.toString().trim();
                    const lastNameStr = lastName ? lastName.toString().trim() : '';
                    const fullName = lastNameStr ? `${firstNameStr} ${lastNameStr}` : firstNameStr;

                    persons.push({
                        index: index,
                        name: fullName,
                        firstName: firstNameStr
                    });
                }
            });

            persons.forEach(person => {
                const personDiv = document.createElement('div');
                personDiv.className = 'person-item';
                if (ignoredPersons.has(person.index)) {
                    personDiv.classList.add('ignored');
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = ignoredPersons.has(person.index);
                checkbox.onchange = () => toggleIgnorePerson(person.index, personDiv);

                const nameSpan = document.createElement('span');
                nameSpan.className = 'person-name';
                nameSpan.textContent = person.name;

                personDiv.appendChild(checkbox);
                personDiv.appendChild(nameSpan);
                personList.appendChild(personDiv);
            });

            updateStatsInfo(persons.length);
        }

        function toggleIgnorePerson(index, element) {
            if (ignoredPersons.has(index)) {
                ignoredPersons.delete(index);
                element.classList.remove('ignored');
            } else {
                ignoredPersons.add(index);
                element.classList.add('ignored');
            }

            const skipFirstRow = ignoreFirstRow.checked;
            let totalPersons = currentData.length;
            if (skipFirstRow && totalPersons > 0) {
                totalPersons -= 1;
            }
            updateStatsInfo(totalPersons);
        }

        function updateStatsInfo(totalPersons) {
            const activePersons = totalPersons - ignoredPersons.size;
            statsInfo.textContent = `üìä Gesamt: ${totalPersons} | Aktiv: ${activePersons} | Ignoriert: ${ignoredPersons.size}`;
        }

        function saveCurrentList() {
            if (currentData.length === 0) {
                alert('‚ùå Keine Daten zum Speichern vorhanden!');
                return;
            }

            const listName = listNameInput.value.trim();
            if (!listName) {
                alert('‚ùå Bitte einen Namen f√ºr die Liste eingeben!');
                return;
            }

            const savedLists = JSON.parse(localStorage.getItem('groupLists') || '{}');

            savedLists[listName] = {
                data: currentData,
                ignoredPersons: Array.from(ignoredPersons),
                timestamp: new Date().toISOString()
            };

            localStorage.setItem('groupLists', JSON.stringify(savedLists));
            currentListName = listName;

            loadSavedLists();
            alert(`‚úÖ Liste "${listName}" gespeichert!`);
            listNameInput.value = '';
        }

        function loadSavedLists() {
            const savedLists = JSON.parse(localStorage.getItem('groupLists') || '{}');
            savedListsContainer.innerHTML = '';

            if (Object.keys(savedLists).length === 0) {
                savedListsContainer.innerHTML = '<p style="color: #999; text-align: center;">Keine gespeicherten Listen</p>';
                return;
            }

            Object.entries(savedLists).forEach(([name, listData]) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'saved-list-item';
                if (currentListName === name) {
                    itemDiv.classList.add('active');
                }

                const nameSpan = document.createElement('span');
                nameSpan.className = 'saved-list-name';
                nameSpan.textContent = name;
                nameSpan.onclick = () => loadList(name);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'saved-list-actions';

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-small btn-delete';
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteList(name);
                };

                actionsDiv.appendChild(deleteBtn);
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(actionsDiv);
                savedListsContainer.appendChild(itemDiv);
            });
        }

        function loadList(name) {
            const savedLists = JSON.parse(localStorage.getItem('groupLists') || '{}');
            const listData = savedLists[name];

            if (!listData) {
                alert('‚ùå Liste nicht gefunden!');
                return;
            }

            currentData = listData.data;
            ignoredPersons = new Set(listData.ignoredPersons || []);
            currentListName = name;

            fileName.textContent = `üìÑ ${name} (gespeichert)`;
            divideBtn.disabled = false;
            displayPersonList();
            loadSavedLists();

            alert(`‚úÖ Liste "${name}" geladen!`);
        }

        function deleteList(name) {
            if (!confirm(`Liste "${name}" wirklich l√∂schen?`)) {
                return;
            }

            const savedLists = JSON.parse(localStorage.getItem('groupLists') || '{}');
            delete savedLists[name];
            localStorage.setItem('groupLists', JSON.stringify(savedLists));

            if (currentListName === name) {
                currentListName = null;
            }

            loadSavedLists();
            alert(`‚úÖ Liste "${name}" gel√∂scht!`);
        }

        function divideIntoGroups() {
            if (currentData.length === 0) {
                alert('Bitte zuerst eine Datei laden!');
                return;
            }

            const mode = divisionMode.value;
            const value = parseInt(groupValue.value);
            const remainder = remainderMode.value;
            const firstNameColIndex = parseInt(nameColumn.value);
            const lastNameColIndex = parseInt(lastNameColumn.value);
            const exclusionColIndex = parseInt(exclusionColumn.value);
            const skipFirstRow = ignoreFirstRow.checked;

            // Prepare data
            let dataToProcess = [...currentData];
            if (skipFirstRow && dataToProcess.length > 0) {
                dataToProcess = dataToProcess.slice(1);
            }

            // Extract person data
            const persons = [];
            const firstNameCount = {};

            dataToProcess.forEach((row, index) => {
                // Skip ignored persons
                if (ignoredPersons.has(index)) {
                    return;
                }

                const firstName = row[firstNameColIndex];
                const lastName = lastNameColIndex >= 0 ? row[lastNameColIndex] : '';
                const exclusionRaw = exclusionColIndex >= 0 ? row[exclusionColIndex] : '';

                if (firstName && firstName.toString().trim() !== '') {
                    const firstNameStr = firstName.toString().trim();
                    const lastNameStr = lastName ? lastName.toString().trim() : '';

                    firstNameCount[firstNameStr] = (firstNameCount[firstNameStr] || 0) + 1;

                    const exclusions = exclusionRaw
                        ? exclusionRaw.toString().split(',').map(e => e.trim()).filter(e => e)
                        : [];

                    persons.push({
                        firstName: firstNameStr,
                        lastName: lastNameStr,
                        exclusions: exclusions,
                        index: index
                    });
                }
            });

            if (persons.length === 0) {
                alert('Keine aktiven Personen gefunden!');
                return;
            }

            // Create display names
            persons.forEach(person => {
                if (firstNameCount[person.firstName] > 1 && person.lastName) {
                    const lastNamePart = person.lastName.substring(0, 3);
                    person.displayName = `${person.firstName} ${lastNamePart}.`;
                } else {
                    person.displayName = person.firstName;
                }
            });

            // Calculate number of groups
            let numGroups;
            let targetGroupSize = null;

            if (mode === 'count') {
                numGroups = Math.min(value, persons.length);
            } else {
                targetGroupSize = value;
                numGroups = Math.floor(persons.length / targetGroupSize);
                const remainderCount = persons.length % targetGroupSize;

                if (remainder === 'separate' && remainderCount > 0) {
                    numGroups += 1;
                }

                if (numGroups === 0) numGroups = 1;
            }

            // Shuffle
            const shuffled = [...persons].sort(() => Math.random() - 0.5);

            // Initialize groups
            currentGroups = Array.from({ length: numGroups }, () => []);

            // Assign persons
            const maxAttempts = 1000;
            let totalAttempts = 0;

            for (const person of shuffled) {
                let assigned = false;
                let attempts = 0;

                while (!assigned && attempts < maxAttempts) {
                    attempts++;
                    totalAttempts++;

                    const groupSizes = currentGroups.map(g => g.length);
                    const minSize = Math.min(...groupSizes);

                    let candidateIndices = groupSizes
                        .map((size, idx) => size === minSize ? idx : -1)
                        .filter(idx => idx !== -1);

                    // For 'size' mode with 'separate', enforce target size
                    if (mode === 'size' && remainder === 'separate' && targetGroupSize) {
                        candidateIndices = candidateIndices.filter(idx => {
                            const isRemainderGroup = idx === numGroups - 1;
                            if (isRemainderGroup) return true;
                            return currentGroups[idx].length < targetGroupSize;
                        });

                        if (candidateIndices.length === 0) {
                            candidateIndices = [numGroups - 1];
                        }
                    }

                    const groupIndex = candidateIndices[Math.floor(Math.random() * candidateIndices.length)];
                    const group = currentGroups[groupIndex];

                    // Check exclusions
                    const hasExclusion = group.some(member => {
                        return checkExclusion(person, member, firstNameCount) ||
                            checkExclusion(member, person, firstNameCount);
                    });

                    if (!hasExclusion) {
                        currentGroups[groupIndex].push(person);
                        assigned = true;
                    }
                }

                // Force assignment if needed
                if (!assigned) {
                    const groupSizes = currentGroups.map(g => g.length);
                    const minSize = Math.min(...groupSizes);
                    const groupIndex = groupSizes.indexOf(minSize);
                    currentGroups[groupIndex].push(person);
                    console.warn(`Warnung: ${person.displayName} musste trotz Ausschluss platziert werden`);
                }
            }

            displayGroups();
            exportBtn.disabled = false;

            if (totalAttempts > shuffled.length * 10) {
                alert('‚ö†Ô∏è Hinweis: Einige Ausschl√ºsse konnten m√∂glicherweise nicht vollst√§ndig ber√ºcksichtigt werden.');
            }
        }

        function checkExclusion(person, member, firstNameCount) {
            return person.exclusions.some(exclusion => {
                const exc = exclusion.trim();
                if (exc === member.displayName) return true;
                if (exc === member.firstName && firstNameCount[member.firstName] === 1) return true;
                if (member.lastName && exc === `${member.firstName} ${member.lastName}`) return true;
                if (member.lastName && exc === `${member.firstName} ${member.lastName.substring(0, 3)}.`) return true;
                return false;
            });
        }

        function displayGroups() {
            groupsContainer.innerHTML = '';

            currentGroups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group';

                const header = document.createElement('div');
                header.className = 'group-header';
                header.textContent = `Gruppe ${index + 1} (${group.length} Personen)`;

                const membersList = document.createElement('ul');
                membersList.className = 'group-members';

                group.forEach(person => {
                    const li = document.createElement('li');
                    li.textContent = person.displayName;
                    membersList.appendChild(li);
                });

                groupDiv.appendChild(header);
                groupDiv.appendChild(membersList);
                groupsContainer.appendChild(groupDiv);
            });
        }

        function exportToExcel() {
            if (currentGroups.length === 0) {
                alert('Bitte zuerst Gruppen einteilen!');
                return;
            }

            const exportData = [];
            const headers = currentGroups.map((_, i) => `Gruppe ${i + 1}`);
            exportData.push(headers);

            const maxSize = Math.max(...currentGroups.map(g => g.length));

            for (let i = 0; i < maxSize; i++) {
                const row = currentGroups.map(group => group[i] ? group[i].displayName : '');
                exportData.push(row);
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            ws['!cols'] = headers.map(() => ({ wch: 20 }));

            XLSX.utils.book_append_sheet(wb, ws, 'Gruppen');

            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const listNameSuffix = currentListName ? `_${currentListName}` : '';
            const filename = `Gruppeneinteilung${listNameSuffix}_${timestamp}.xlsx`;

            XLSX.writeFile(wb, filename);
        }

        // Update person list when settings change
        nameColumn.addEventListener('change', () => {
            if (currentData.length > 0) displayPersonList();
        });
        lastNameColumn.addEventListener('change', () => {
            if (currentData.length > 0) displayPersonList();
        });
        ignoreFirstRow.addEventListener('change', () => {
            if (currentData.length > 0) displayPersonList();
        });
    </script>
</body>

</html>